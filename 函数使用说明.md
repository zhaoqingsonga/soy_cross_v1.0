 
# 杂交组合配制工具包详细使用说明（V1.0）
作者：赵青松
2025-08-06

本工具包提供了一套完整的杂交组合管理与配制功能，包括配制杂交组合、生成杂交组合矩阵、杂交组合统计等。以下是各函数的详细使用说明：


# 1 亲本表及组合表维护

## 1.1  initialize_parent_table - 初始化亲本表
### 功能描述
将原始亲本数据标准化，添加唯一ID字段，格式为"PXXXX"。标准化后保存为RDS文件。原始亲本表结构为名称+性状格式。
### 参数说明
- **df**：原始亲本信息数据框，必须包含"名称"字段，其它性状字段无要求。
- **file_path**：输出路径，默认"data/parent_table.rds"
### 使用示例
```r
# 创建示例亲本数据
parents <- data.frame(
  名称 = c("亲本A", "亲本B", "亲本C"),
  株高 = c(150, 160, 155),
  千粒重 = c(25, 28, 26)
)
# 初始化并保存
initialize_parent_table(parents, "data/my_parents.rds")
```
### 输出结果
- 返回标准化的数据框，包含自动生成的id列
- 数据按id排序，id列位于最前
- 自动创建输出目录（如不存在）
### 注意事项
- 输入数据必须包含"名称"字段
- ID自动生成，格式为"P0001"、"P0002"等
- 保存为RDS格式，便于R程序直接读取
- 

## 1.2 combine_records - 初始化杂交组合表
### 功能描述
从标准亲本表生成所有可能的两两杂交组合，为每个组合的字段添加 ma_（母本）和 pa_（父本）前缀，并保存为RDS文件。
### 参数说明
- `df`（可选）：输入数据框，默认从"data/parent_table.rds"加载
- `file`：输出文件路径，默认为"data/cross_table.rds"
### 使用示例
```r
# 使用默认文件生成组合
combine_records()
# 使用自定义数据框
my_parents <- data.frame(名称 = c("P1", "P2", "P3"), 株高 = c(150, 160, 155))
combine_records(df = my_parents)
# 指定输出路径
combine_records(file = "output/my_crosses.rds")
```
### 输出结果
- 返回组合数据框，包含pair_id、ma_row、pa_row、content等字段
- 自动创建输出目录（如不存在）
- 生成所有可能的两两组合（包括正反交）



## 1.3  add_parent_and_append_cross - 添加亲本并更新组合
### 功能描述
添加新亲本并自动生成所有可能的杂交组合（包括正交和反交），同时更新亲本表和组合表。
### 参数说明
- **new_data**：包含"名称"字段的数据框
- **parent_file**：亲本主表RDS路径（默认"data/parent_table.rds"）
- **cross_file**：杂交组合表RDS路径（默认"data/cross_table.rds"）
### 使用示例
```r
# 添加新亲本并自动生成组合
new_parents <- data.frame(
  名称 = c("亲本F", "亲本G")
)
add_parent_and_append_cross(
  new_parents,
  parent_file = "data/parent_table.rds",
  cross_file = "data/cross_table.rds"
)
```
### 输出结果
- 更新亲本表（添加新亲本和自动生成的ID）
- 自动生成所有新亲本与现有亲本（包括其他新亲本）的组合
- 组合包含正交和反交
- 返回更新后的组合数据框
### 注意事项
- 自动排除自交组合（ma_row != pa_row）
- 组合ID格式为"P0001_P0002"（小号在前）
- 自动创建输出目录（如不存在）
- 不会重复添加已存在的组合
## 1.4 remove_last_parents - 删除亲本并同步更新组合表
### 功能描述
从亲本主表中删除最后添加的N个亲本，并从组合表中删除所有涉及这些亲本的组合记录。
### 参数说明
- **n**：删除的亲本个数（只能从尾部删除）
- **parent_file**：RDS亲本主表路径（默认"data/parent_table.rds"）
- **cross_file**：RDS组合记录路径（默认"data/cross_table.rds"）
### 使用示例
```r
# 删除最后添加的2个亲本
remove_last_parents(
  n = 2,
  parent_file = "data/parent_table.rds",
  cross_file = "data/cross_table.rds"
)
```
### 输出结果
- 删除指定数量的亲本记录（从末尾开始）
- 同步删除所有涉及这些亲本的组合记录
- 返回更新后的亲本数据框
- 提供详细的操作确认和结果反馈
### 注意事项
- 只能删除最后添加的亲本（按ID排序）
- 删除前会显示将要删除的亲本信息并要求确认
- 自动同步更新组合表，删除相关组合
- 如果组合表不存在，只更新亲本表


## 1.5 edit_parent_table - 编辑亲本表
### 功能描述
交互式编辑亲本表，支持自动备份和变更日志记录。
### 参数说明
- file：亲本表RDS文件路径，默认"data/parent_table.rds"
- backup_dir：备份目录，默认"backup"
- log_file：变更日志CSV文件路径，默认"logs/parent_edit_log.csv"
### 使用示例
```r
# 基本用法
edit_parent_table()
# 指定文件路径
edit_parent_table(file = "my_data/my_parents.rds")
# 自定义备份和日志位置
edit_parent_table(
  backup_dir = "backups/parents",
  log_file = "logs/my_parent_changes.csv"
)
```
### 功能特点
1. **自动备份**：每次编辑前自动创建带时间戳的备份文件
2. **变更检测**：自动检测数据变更并记录变更数量
3. **类型检查**：自动检查数值型字段的数据类型
4. **日志记录**：详细记录每次编辑的时间、文件路径、变更情况
5. **安全恢复**：可通过备份文件恢复历史版本
### 返回值
返回修改后的数据框（invisible返回）


## 1.6 edit_parent_table_via_excel - Excel方式编辑亲本表
### 功能描述
通过Excel文件导出和导入的方式编辑亲本表，适合需要批量编辑的场景。
### 参数说明
- mode：操作模式，"export"（导出）或"import"（导入），默认"export"
- rds_path：RDS文件路径，默认"data/parent_table.rds"
- xlsx_path：Excel文件路径，默认"parent_table_edit.xlsx"
- backup：导入时是否备份，默认TRUE
### 使用示例
```r
# 导出Excel进行编辑
edit_parent_table_via_excel()
# 导入编辑后的Excel
edit_parent_table_via_excel(mode = "import")
# 指定文件路径
edit_parent_table_via_excel(
  rds_path = "my_data/my_parents.rds",
  xlsx_path = "my_edit.xlsx"
)
```
### 功能特点
1. **可视化编辑**：在Excel中直观编辑表格数据
2. **格式优化**：自动设置列宽和标题样式
3. **类型验证**：导入时检查数值型字段
4. **自动备份**：导入前自动备份原文件
5. **灵活操作**：支持独立导出或导入操作
### 返回值
- export模式：返回Excel文件路径
- import模式：返回导入后的数据框


## 1.7 `edit_parent_table_app` 函数使用说明

### 功能描述
`edit_parent_table_app` 函数用于启动一个基于 `rhandsontable` 的 Excel 风格编辑器，专门用于编辑亲本表数据。该函数提供了一个交互式的图形界面，允许用户查看、编辑表格数据，并支持保存修改或取消操作。

### 语法
```r
edit_parent_table_app(file = "data/parent_table.rds")
```

### 参数说明
- `file`：字符串，可选参数，指定 RDS 文件的路径。默认值为 `"data/parent_table.rds"`，表示程序会默认读取该路径下的亲本表数据文件。

### 返回值
该函数启动一个 Shiny 应用程序（通过 `runGadget`），没有实际的返回值。所有操作都在图形界面中完成。

### 使用方法

#### 基本使用
- 直接调用函数（使用默认文件路径）：
   ```r
   edit_parent_table_app()
   ```

- 指定自定义文件路径：
   ```r
   edit_parent_table_app(file = "path/to/your/custom_table.rds")
   ```

#### 界面操作说明
启动应用后，会打开一个标题为"亲本表编辑器"的窗口，包含以下元素和功能：

-  **表格区域**：
   - 显示从 RDS 文件加载的数据
   - 支持单元格直接编辑（类似 Excel）
   - 可通过右键菜单进行更多操作（插入/删除行/列等）
   - 支持列宽调整和行高固定（30px）
   - 包含行头和列头，方便定位
   - 具有行列高亮功能，提升编辑体验

-  **操作按钮**：
   - "💾 保存修改"按钮：保存当前所有编辑到文件
     - 保存前会自动创建原始数据的备份
     - 备份文件位于"data/backups/"目录下，文件名包含时间戳
   - "❌ 退出不保存"按钮：关闭编辑器且不保存修改
     - 若有未保存的修改，会弹出确认对话框

-  **状态信息区**：
   - 显示操作结果信息（保存成功/失败、备份文件路径等）

### 注意事项

-  **文件要求**：
   - 函数会检查指定路径的文件是否存在，若不存在会抛出错误
   - 输入文件必须是 RDS 格式（由 `saveRDS` 生成）
   - 文件内容应是一个数据框（data frame）

 - **备份机制**：
   - 每次保存时会自动创建备份文件
   - 备份文件命名格式：`parent_table_backup_YYYYMMDD_HHMMSS.rds`
   - 备份文件存储在"data/backups/"目录，若该目录不存在会自动创建

- **未保存修改提醒**：
   - 若有未保存的修改，退出时会显示警告
   - 点击"退出不保存"按钮时会提示确认

- **依赖包**：
   - 函数会自动加载所需的依赖包：`shiny`、`rhandsontable` 和 `shinyjs`
   - 确保这些包已安装，若未安装可通过 `install.packages()` 安装

### 错误处理
- 若指定的文件不存在，函数会立即停止并显示错误信息
- 保存过程中发生错误（如权限问题），会在状态区显示错误信息

### 示例
```r
# 编辑默认路径下的亲本表
edit_parent_table_app()

# 编辑自定义路径的亲本表
edit_parent_table_app(file = "my_data/parents.rds")
```

# 2 组合矩阵表相关操作


## 2.1 export_cross_matrix - 组合表导出到杂交矩阵
### 功能描述
从组合数据中提取杂交信息，生成n×n杂交矩阵。输出两个文件：一个为.rds格式（仅包含正交组合），一个为.xlsx格式（包含正交和反交组合）。
### 参数说明
- **df**（可选）：组合数据框，若为NULL则从file_rds加载
- **file_rds**：RDS输入文件路径（默认"data/cross_table.rds"）
- **file_rds_out**：RDS输出文件路径（正交内容，默认"data/cross_matrix.rds"）
- **file_excel_out**：Excel输出文件路径（含反交内容，默认"data/cross_matrix_reverse.xlsx"）
- **n**：可选，矩阵维度，默认自动推断
### 使用示例
```r
# 使用默认参数生成矩阵
export_cross_matrix()
# 指定输入文件和输出路径
export_cross_matrix(
  file_rds = "my_data/my_crosses.rds",
  file_rds_out = "output/my_matrix.rds",
  file_excel_out = "output/my_matrix.xlsx"
)
# 使用自定义数据框
my_crosses <- readRDS("data/cross_table.rds")
export_cross_matrix(df = my_crosses)
```
### 输出结果
- 返回一个列表，包含两个矩阵：rds_matrix（仅正交）和excel_matrix（含正交和反交）
- 自动创建输出目录（如不存在）
- 生成带有行列名的完整杂交矩阵
### 注意事项
- 需要安装openxlsx包
- 输入数据必须包含"ma_row"、"pa_row"、"content"、"ma_名称"、"pa_名称"字段
- 自动过滤掉无效记录（NA或空内容）



## 2.1 fill_content_from_matrix - 从矩阵填充组合表
### 功能描述
自动将交叉矩阵内容填入组合表的content字段，支持添加反交记录、覆盖已有内容，以及预览修改结果。
### 参数说明
- `matrix`：矩阵对象，若为空则从matrix_file文件加载
- `matrix_file`：矩阵文件路径，默认"data/cross_matrix.rds"
- `add_symmetric`：是否添加反交记录，默认TRUE
- `overwrite`：是否覆盖已有content值，默认TRUE
- `preview`：是否仅预览修改，不保存，默认FALSE
### 使用示例
```r
# 从文件加载矩阵并填充
fill_content_from_matrix()
# 使用自定义矩阵
my_matrix <- matrix(c("A1", "A2", "", "B1"), nrow = 2)
fill_content_from_matrix(matrix = my_matrix, add_symmetric = FALSE)
# 预览模式，不实际保存
fill_content_from_matrix(preview = TRUE)
```
### 输出结果
- 返回被修改的记录数据框
- 预览模式返回将要修改的记录
- 实际修改会保存到默认组合表文件



# 3 杂交相关统计


## 3.1 summarize_by_mother_name - 母本使用统计
### 功能描述
按母本名称统计每个亲本作为母本参与的组合次数，列出使用过的父本列表及母本自身信息。
### 参数说明
- `df`：包含ma_名称、pa_名称、content等字段的数据框
- `include_empty_content`：是否包含content为空的记录，默认FALSE
### 使用示例
```r
# 统计有内容的组合
summarize_by_mother_name(df = cross_table)
# 包含空内容的统计
summarize_by_mother_name(df = cross_table, include_empty_content = TRUE)
```
### 输出结果
- 返回数据框，每行为一个母本
- 包含组合次数n_combinations和所用父本列表used_fathers
- 包含母本自身所有ma_开头的字段信息


## 3.2 summarize_by_father_name - 父本使用统计
### 功能描述
按父本名称统计每个亲本作为父本参与的组合次数，列出使用过的母本列表及父本自身信息。
### 参数说明
- `df`：包含pa_名称、ma_名称、content等字段的数据框
- `include_empty_content`：是否包含content为空的记录，默认FALSE
### 使用示例
```r
# 统计有内容的组合
summarize_by_father_name(df = cross_table)
# 包含空内容的统计
summarize_by_father_name(df = cross_table, include_empty_content = TRUE)
```
### 输出结果
- 返回数据框，每行为一个父本
- 包含组合次数n_combinations和所用母本列表used_mothers
- 包含父本自身所有pa_开头的字段信息


## 3.4  merge_mother_father_stats - 合并母本与父本统计
### 功能描述
合并母本和父本的使用统计，生成亲本综合使用表。
### 参数说明
- `df`（可选）：组合数据框
- `include_empty_content`：是否包含content为空的组合，默认FALSE
### 使用示例
```r
# 使用默认文件合并统计
merge_mother_father_stats()
# 包含空内容的统计
merge_mother_father_stats(include_empty_content = TRUE)
```
### 输出结果
- 返回综合数据框，包含每个亲本在母本和父本方向的使用情况
- 包含n_as_mother、n_as_father等统计字段
- 自动合并重复的亲本信息字段


# 4 杂交组合相关操作

## 4.1 generate_cross_plan - 配置杂交组合
### 功能描述
生成杂交配置计划，支持筛选、自定义content，自动避免自交。
### 参数说明
- `df`：组合数据框
- `n`：欲配置的组合数量
- `mother_names`：可选，母本名称列表
- `father_names`：可选，父本名称列表
- `mother_filter`：可选，母本筛选表达式
- `father_filter`：可选，父本筛选表达式
- `content_value`：可选，填写到content字段的值
### 使用示例
```r
# 随机选择10个组合
generate_cross_plan(df = cross_table, n = 10)
# 指定母本和父本
generate_cross_plan(df = cross_table, n = 5, 
                    mother_names = c("P1", "P2"),
                    father_names = c("P3", "P4"))
# 添加筛选条件
generate_cross_plan(df = cross_table, n = 8,
                    mother_filter = quote(ma_株高 > 150),
                    father_filter = quote(pa_蛋白 > 12))
```
### 输出结果
- 返回列表，包含plan（配置成功的组合）和updated_df（更新后的完整表）
- 自动生成反交记录
- content字段默认使用当前日期
 

## 4.2  run_cross_plan - 执行杂交计划
### 功能描述
读取组合表，执行杂交配置计划，并保存结果到RDS文件。
### 参数说明
- `n`：欲生成的组合数量
- `mother_names`：可选，母本名称向量
- `father_names`：可选，父本名称向量
- `mother_filter`：可选，母本条件表达式
- `father_filter`：可选，父本条件表达式
- `content_value`：可选，写入content字段的值
- `file`：RDS文件路径，默认"data/cross_table.rds"
### 使用示例
```r
# 执行计划并保存
run_cross_plan(n = 10)
# 带筛选条件的执行
run_cross_plan(n = 5,
               mother_names = c("P1", "P2"),
               father_filter = quote(pa_株高 < 160),
               content_value = "2025-06-10批次")
```
### 输出结果
- 返回计划组合列表
- 自动保存更新后的组合表
- 生成操作日志到logs/cross_plan_log.csv


## 4.3 summarize_cross_batches - 按批次统计杂交组合
### 功能描述
从组合数据中按content（通常为日期或批次名称）分组统计正交组合数量。
### 参数说明
- `df`（可选）：含content字段的组合数据框
- `file`：默认读取路径为"data/cross_table.rds"
### 使用示例
```r
# 使用默认文件统计
summarize_cross_batches()
# 使用自定义数据框
summarize_cross_batches(df = my_crosses)
# 指定文件路径
summarize_cross_batches(file = "data/my_crosses.rds")
```
### 输出结果
- 返回数据框，每行代表一个批次
- 包含content值和该批次的组合数量n_crosses
- 自动过滤掉"反交"记录



## 4.4. filter_cross_by_batches - 按批次提取杂交组合
### 功能描述
根据指定content值（如批次名称、日期等），提取对应的杂交组合记录。
### 参数说明
- `batches`：字符向量，指定一个或多个content值
- `df`（可选）：组合数据框
- `file`：默认路径为"data/cross_table.rds"
### 使用示例
```r
# 提取单个批次
filter_cross_by_batches("2025-06-10")
# 提取多个批次
filter_cross_by_batches(c("2025-06-10", "2025-06-11"))
```
### 输出结果
- 返回指定批次的组合记录数据框
- 自动过滤掉空content和"反交"记录
- 按content和pair_id排序


## 4.5  clear_cross_batches - 清除指定批次杂交组合
### 功能描述
删除指定content批次的正交记录，并同步清除对应反交组合的content字段。
### 参数说明
- `batches`：字符向量，指定要清除的content批次名
- `df`（可选）：手动传入组合数据框
- `file`：RDS文件路径，默认"data/cross_table.rds"
- `preview`：是否仅预览，默认FALSE
- `verbose`：是否输出详细日志，默认FALSE
### 使用示例
```r
# 预览将要清除的内容
clear_cross_batches("2025-06-10", preview = TRUE)
# 实际清除批次内容
clear_cross_batches(c("2025-06-10", "2025-06-11"))
```
### 输出结果
- 预览模式返回将被清除的记录
- 实际操作返回确认信息并更新文件
- 包含清除记录数量的统计信息


# 5 目录结构及重要维护文件

## 5.1  目录结构

├─data（杂交组合数据相关表）  
│  ├─backups（数据备份表）
│  └─temp（临时文件）
├─docs
├─logs（杂交组合日志文件）
├─output（杂交组合的输出文件）
│  ├─G（转基因组合）
│  └─N（常规组合）
├─R（R语言程序文件）
├─renv（依赖包）
└─tests（测试文件）

## 5.2 重要维护文件
### data/parent_table.rds(亲本表)
存放用于做杂交的亲本，由initialize_parent_table函数生成，字段为ID，名称，根据需要加上其它性状。此表可用函数add_parent_and_append_cross函数来增加亲本，或由remove_last_parents函数来删除亲本，增加或删除亲本时对应的data/parent_table.rds会增加组合或删除组合。可用edit_parent_table函数，edit_parent_table_via_excel函数或是edit_parent_table_app函数来编辑亲本表内容，字段内容进行修改，但不能增加或是删除记录。
### data/cross_table.rds（组合表）
由亲本所形成的所有组合，可由combine_records函数生成。所用亲本默认为data/parent_table.rds亲本。用add_parent_and_append_cross函数来增加亲本，或由remove_last_parents函数来删除亲本时会联动增加或删除，当运行run_cross_plan函数时会改变content字段内容。指示是否杂交已做。 当运行clear_cross_batches函数时同样会按批次清除content字段内容，指示这些杂交未做。

### data/cross_matrix.rds和data/cross_matrix.xlsx（组合矩阵表）
由函数export_cross_matrix函数生成。将cross_table格式的数据转化为矩阵形式（cross_matrix). RDS格式只有正交内容，而xlsx格式为正反交结果。

### logs/cross_plan_log.csv（组合配置的日志文件）

由函数run_cross_plan函数生成。





# 6  最佳实践建议
## 日常编辑流程
```r
# 方式1：直接R编辑（少量修改）
edit_parent_table()
# 方式2：Excel编辑（批量修改）
edit_parent_table_via_excel()  # 编辑Excel文件
edit_parent_table_via_excel(mode = "import")  # 导入修改
```
## 杂交计划制定
```r
# 自然语言方式（推荐）
parse_cross_command("配置10个组合，母本蛋白大于12，父本株高小于160，不包含转基因")
# 传统编程方式
run_cross_plan(
  n = 10,
  mother_filter = as_mother_filter("蛋白 > 12"),
  father_filter = as_father_filter("株高 < 160"),
  exclude_names = c("转基因亲本A", "转基因亲本B")
)
```

## 数据维护建议
1. 定期备份重要数据文件
2. 使用日志功能追踪数据变更
3. 复杂编辑前先导出Excel预览
4. 重要操作后验证数据完整性
5. 保持字段命名一致性
这套工具包提供了从数据编辑到计划执行的完整工作流，可根据实际需求灵活组合使用各函数。


## 数据准备：
   - 确保亲本数据包含必要的识别字段（如"名称"）
   - 杂交组合矩阵应为方阵，行列对应相同亲本
   
## 组合生成：
   - 先使用`combine_records`生成完整组合表
   - 根据需要使用`fill_content_from_matrix`填充内容
## 统计分析：
   - 使用`summarize_cross_batches`了解批次分布
   - 通过`summarize_by_mother_name`和`summarize_by_father_name`分析亲本使用情况
   
## 计划执行：

   - 使用`generate_cross_plan`预览配置计划
   - 确认后通过`run_cross_plan`执行并保存
   - 定期检查`logs/cross_plan_log.csv`了解操作历史
##  数据维护：
   - 使用`filter_cross_by_batches`查看特定批次
   - 使用`clear_cross_batches`清理不需要的批次记录

##  数据初始化流程：
   ```r
   # 1. 初始化亲本表
   initialize_parent_table(original_parents)
   
   # 2. 生成初始组合
   combinerecords()
   
   # 3. 生成杂交矩阵
   export_cross_matrix()
   ```
## 添加新亲本流程：
   ```r
   # 添加单个亲本
   add_parent_record(new_parent)
   
   # 或者添加亲本并自动生成组合
   add_parent_and_append_cross(new_parents)
   ```
## 数据维护：
   - 使用`remove_last_parents`可以撤销最近的添加操作
   - 定期使用`export_cross_matrix`生成最新矩阵
   - 重要操作前建议备份数据
    
## 文件管理：
   - 亲本表建议使用RDS格式（`initialize_parent_table`）
   - 组合表使用RDS格式（`combinerecords`）
   - 矩阵导出使用两种格式（RDS和Excel）
